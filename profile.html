<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

    <link href="./css/styleProfile.css" rel="stylesheet" />
    <link href="./css/stylesProfile.css" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>Quiz Game</title>
    <!-- Favicon-->

    <!-- Bootstrap Icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Merriweather+Sans:400,700" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic" rel="stylesheet" type="text/css" />
    <!-- SimpleLightbox plugin CSS-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.css" rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <!--            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>-->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!--    <script language="javascript" src="js/scripts.js"></script>-->
</head>
<!------ Include the above in your HEAD tag ---------->
<body style="background: white">
    <nav class="navbar navbar-expand-lg navbar-light fixed-top py-3" id="mainNav" style="background: white; box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px">
        <div class="container">
            <a class="navbar-brand" href="./quiz.html" style="color: #59ab6e; font-size: 30px">Quiz Game</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="collapsibleNavbar">
                <ul class="navbar-nav ms-auto my-2 my-lg-0">
                    <li class="nav-item"><a class="nav-link" style="color: #59ab6e; font-size: 20px" href="./quiz.html">Home</a></li>
                    <li class="infoUser" style="display: flex; align-items: center; font-size: 20px; color: #59ab6e"></li>
                </ul>
            </div>
        </div>
    </nav>
    <header class="masthead" style="background: white">
        <div class="container emp-profile" style="box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px; margin-top: 150px">
            <div class="row">
                <div class="col-md-4">
                    <div class="profile-img">
                        <img alt="" class="image-profile" />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="profile-head">
                        <!-- <h5>3 ga pro build auto top 8</h5> -->
                        <p class="proile-rating"></p>
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#home">Home</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#profile">History</a>
                            </li>
                        </ul>
                        <div class="tab-content col-md-9">
                            <div role="tabpanel" class="tab-pane active" style="padding-top: 20px" id="home">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label style="font-weight: bold; font-size: 19px">UserName: </label>
                                    </div>
                                    <div class="col-md-5">
                                        <p class="username"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label style="font-weight: bold; font-size: 19px">FullName:</label>
                                    </div>
                                    <div class="col-md-5">
                                        <p class="name"></p>
                                    </div>
                                </div>
                            </div>
                            <div role="tabpanel" class="tab-pane" style="padding-top: 20px" id="profile">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Quiz Name</th>
                                            <th>Score</th>
                                            <th>Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>1</td>
                                            <td>Anna</td>
                                            <td>85</td>
                                            <td>11-12-2021</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div>
                        <button
                            type="button"
                            class="btn btn-secondary"
                            style="background: linear-gradient(45deg, #59ab6e 0%, rgba(66, 245, 189, 0.4) 100%)"
                            data-toggle="modal"
                            data-target="#myModal"
                            onclick="editProfile()"
                        >
                            Edit profile
                        </button>
                    </div>
                    <div style="padding-top: 10px">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            style="background: linear-gradient(45deg, #59ab6e 0%, rgba(66, 245, 189, 0.4) 100%)"
                            data-toggle="modal"
                            data-target="#myModalpass"
                        >
                            Edit password
                        </button>
                    </div>
                </div>
                <div class="modal" id="myModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form id="edit-profile">
                                <!-- Modal Header -->
                                <div class="modal-header">
                                    <h4 class="modal-title">Edit Profile</h4>
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                </div>
                                <!-- Modal body -->
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label>FullName</label>
                                        <input type="text" class="form-control fullname" required />
                                    </div>
                                    <label>Image</label>
                                    <br />
                                    <div class="store-image"></div>
                                    <br />
                                    <input type="file" id="file" />
                                </div>
                                <!-- Modal footer -->
                                <div class="modal-footer">
                                    <input type="button" class="btn btn-default" data-dismiss="modal" value="Cancel" />
                                    <input
                                        type="submit"
                                        style="background: linear-gradient(45deg, rgba(66, 183, 245, 0.8) 0%, rgba(66, 245, 189, 0.4) 100%)"
                                        class="btn btn-info"
                                        value="Save"
                                    />
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal" id="myModalpass">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form id="change-password">
                                <!-- Modal Header -->
                                <div class="modal-header">
                                    <h4 class="modal-title">Change pass</h4>
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                </div>
                                <!-- Modal body -->
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label>Old pass</label>
                                        <input type="password" class="form-control old-password" required />
                                        <div class="error-password" style="color: red"></div>
                                    </div>
                                    <div class="form-group">
                                        <label>New pass</label>
                                        <input type="password" class="form-control new-password" required />
                                    </div>
                                    <div class="form-group">
                                        <label>Confirm</label>
                                        <input type="password" class="form-control confirm" required />
                                        <div style="color: red" class="error-confirm"></div>
                                    </div>
                                </div>
                                <!-- Modal footer -->
                                <div class="modal-footer">
                                    <input type="button" class="btn btn-default" data-dismiss="modal" value="Cancel" />
                                    <input
                                        type="submit"
                                        style="background: linear-gradient(45deg, rgba(66, 183, 245, 0.8) 0%, rgba(66, 245, 189, 0.4) 100%)"
                                        class="btn btn-info"
                                        value="Save"
                                    />
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="small text-center text-muted">Nhóm 7 - Quiz Game Assginment</div>
    </header>
    <script>
        const infoUser = document.querySelector('.infoUser');
        if (localStorage.getItem('username') == null) {
            infoUser.innerHTML = `
                    <li class="nav-item"><a class="nav-link"  href="./register.html">Register</a></li>
                    <li class="nav-item"><a class="nav-link"  href="./login.html">Login</a></li>
                `;
        } else {
            infoUser.innerHTML = `
                
                <li class="nav-item"><a class="nav-link" style="color: #59ab6e;font-size:20px"  href="./login.html" onclick="logout()">Logout</a></li>
                <li class="nav-item"><a   style ="color: #59ab6e;font-weight: bold;"   >Username&nbsp:&nbsp${localStorage.getItem('username')}</a></li>
                
                `;
        }
    </script>

    <script>
        (function () {
            const username = document.querySelector('.username');
            const name = document.querySelector('.name');
            const imageProfile = document.querySelector('.image-profile');

            const user = localStorage.getItem('username');

            const api = `https://quiz-project.azurewebsites.net/findByUserName/${user}`;

            fetch(api)
                .then((res) => res.json())
                .then((data) => {
                    username.innerHTML = data.username;
                    name.innerHTML = data.fullname;
                    if (data.image != null) {
                        imageProfile.setAttribute('src', data.image);
                    }
                })
                .catch((error) => console.log(error));
        })();
    </script>

    <script>
        const form = document.querySelector('#change-password');
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const oldpasword = document.querySelector('.old-password').value;
            const newpassword = document.querySelector('.new-password').value;
            const confirm = document.querySelector('.confirm').value;
            const errorConfirm = document.querySelector('.error-confirm');
            const errorPassword = document.querySelector('.error-password');

            console.log(newpassword, confirm);

            if (newpassword != confirm) {
                errorConfirm.innerHTML = 'Confirm password not match';
                return;
            }

            const username = localStorage.getItem('username');

            const modal = $('#myModalpass');

            const apiGet = `https://quiz-project.azurewebsites.net/findByUserName/${username}`;
            fetch(apiGet)
                .then((res) => res.json())
                .then((data) => {
                    console.log(data);
                    const id = data.id;
                    const fullname = data.fullname;
                    const image = data.image;
                    var password = data.password;
                    const role = data.role;
                    const username = data.username;

                    if (data.password != oldpasword) {
                        errorPassword.innerHTML = 'Wrong password';
                        return;
                    }
                    password = newpassword;
                    const apiPut = `https://quiz-project.azurewebsites.net/updateUser/${username}`;
                    fetch(apiPut, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id,
                            fullname,
                            image,
                            password,
                            role,
                            username,
                        }),
                    })
                        .then(() => {
                            modal.hide();
                            location.assign('./profile.html');
                        })
                        .catch((error) => console.log(error));
                })
                .catch((error) => console.log(error));
        });
    </script>

    <script>
        const formEdit = document.querySelector('#edit-profile');
        formEdit.addEventListener('submit', async (e) => {
            e.preventDefault();

            const newFullname = document.querySelector('.fullname').value;
            const imageFile = document.querySelector('#file').files[0];
            var imageUrl = '';

            if (imageFile != null) {
                const { url } = await axios
                    .get('https://upload-image-123.azurewebsites.net/')
                    .then((res) => res.data)
                    .catch((error) => console.log(error));
                console.log(url);

                // post the image directly to the s3 bucket
                await axios(url, {
                    method: 'put',
                    headers: {
                        'Content-Type': 'multipart/form-data',
                    },
                    data: imageFile,
                });

                imageUrl = url.split('?')[0];
            }

            const username = localStorage.getItem('username');

            const modal = $('#myModal');

            const apiGet = `https://quiz-project.azurewebsites.net/findByUserName/${username}`;
            fetch(apiGet)
                .then((res) => res.json())
                .then((data) => {
                    console.log(data);
                    const id = data.id;
                    const fullname = newFullname;
                    var image = data.image;
                    if (imageUrl != null) {
                        image = imageUrl;
                    }
                    var password = data.password;
                    const role = data.role;
                    const username = data.username;
                    const apiPut = `https://quiz-project.azurewebsites.net/updateUser/${username}`;
                    fetch(apiPut, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id,
                            fullname,
                            image,
                            password,
                            role,
                            username,
                        }),
                    })
                        .then(() => {
                            modal.hide();
                            location.assign('./profile.html');
                        })
                        .catch((error) => console.log(error));
                })
                .catch((error) => console.log(error));
        });
    </script>

    <script>
        function editProfile() {
            const fullname = document.querySelector('.fullname');
            const image = document.querySelector('.store-image');
            const username = localStorage.getItem('username');

            const apiGet = `https://quiz-project.azurewebsites.net/findByUserName/${username}`;
            fetch(apiGet)
                .then((res) => res.json())
                .then((data) => {
                    fullname.value = data.fullname;
                    if (data.image != null) {
                        image.innerHTML = `
                        <img src=${data.image} width="100" >
                        `;
                    }
                })
                .catch((error) => console.log(error));
        }
    </script>
</body>
